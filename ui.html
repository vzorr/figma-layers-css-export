<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Layers to CSS Generator</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 12px;
      color: var(--figma-color-text);
      background-color: var(--figma-color-bg);
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .header {
      padding: 16px;
      border-bottom: 1px solid var(--figma-color-border);
      background-color: var(--figma-color-bg-secondary);
    }

    .header h1 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .header p {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
    }

    .layers-panel {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .layer-item {
      display: flex;
      align-items: center;
      padding: 8px;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 2px;
      font-size: 11px;
      border: 1px solid transparent;
    }

    .layer-item:hover {
      background-color: var(--figma-color-bg-hover);
    }

    .layer-item.selected {
      background-color: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
    }

    .layer-icon {
      margin-right: 8px;
      font-size: 14px;
    }

    .layer-name {
      flex: 1;
      font-weight: 500;
    }

    .layer-type {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      padding: 2px 6px;
      background-color: var(--figma-color-bg-secondary);
      border-radius: 2px;
    }

    .layer-children {
      margin-left: 20px;
    }

    .expand-btn {
      background: none;
      border: none;
      color: var(--figma-color-text-secondary);
      cursor: pointer;
      margin-right: 4px;
      font-size: 10px;
      width: 16px;
      text-align: center;
    }

    .actions {
      padding: 16px;
      border-top: 1px solid var(--figma-color-border);
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 8px 16px;
      border: 1px solid var(--figma-color-border);
      border-radius: 4px;
      background-color: var(--figma-color-bg);
      color: var(--figma-color-text);
      font-size: 11px;
      cursor: pointer;
      flex: 1;
    }

    .btn:hover:not(:disabled) {
      background-color: var(--figma-color-bg-hover);
    }

    .btn.primary {
      background-color: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
      border-color: var(--figma-color-bg-brand);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      text-align: center;
      padding: 40px 20px;
      color: var(--figma-color-text-secondary);
    }

    .error {
      color: #ff5555;
      background-color: #ffe0e0;
      padding: 8px 12px;
      border-radius: 4px;
      margin: 8px;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üé® Layers to CSS Generator</h1>
      <p>Click a layer to select it, then use the actions below</p>
    </div>

    <div class="layers-panel" id="layersPanel">
      <div class="status">Loading current page layers...</div>
    </div>

    <div class="actions">
      <button class="btn" id="selectBtn" disabled>Select in Figma</button>
      <button class="btn" id="copyBtn" disabled>Copy JSON</button>
      <button class="btn primary" id="refreshBtn">Refresh</button>
    </div>
  </div>

  <script>
    console.log("üåê UI starting...");

    let selectedLayer = null;
    let layersData = [];
    let expandedItems = new Set();

    const layersPanel = document.getElementById('layersPanel');
    const selectBtn = document.getElementById('selectBtn');
    const copyBtn = document.getElementById('copyBtn');
    const refreshBtn = document.getElementById('refreshBtn');

    function showStatus(message) {
      layersPanel.innerHTML = `<div class="status">${message}</div>`;
    }

    function showError(message) {
      layersPanel.innerHTML = `<div class="error">‚ùå ${message}</div>`;
    }

    function getLayerIcon(type) {
      const icons = {
        'PAGE': 'üìÑ',
        'FRAME': 'üü¶',
        'COMPONENT': 'üß©',
        'INSTANCE': 'üì±',
        'TEXT': 'üìù',
        'RECTANGLE': '‚¨ú',
        'ELLIPSE': '‚≠ï',
        'POLYGON': 'üî∏',
        'STAR': '‚≠ê',
        'VECTOR': '‚úèÔ∏è',
        'IMAGE': 'üñºÔ∏è',
        'GROUP': 'üìÅ'
      };
      return icons[type] || '‚ö™';
    }

    function renderLayer(layer, depth = 0) {
      const hasChildren = layer.children && layer.children.length > 0;
      const isExpanded = expandedItems.has(layer.id);
      const isSelected = selectedLayer && selectedLayer.id === layer.id;
      
      let html = `
        <div class="layer-item ${isSelected ? 'selected' : ''}" 
             data-layer-id="${layer.id}" 
             style="margin-left: ${depth * 16}px;">
          ${hasChildren ? 
            `<button class="expand-btn" data-toggle="${layer.id}">
              ${isExpanded ? '‚ñº' : '‚ñ∂'}
            </button>` : 
            '<span class="expand-btn"></span>'
          }
          <span class="layer-icon">${getLayerIcon(layer.type)}</span>
          <span class="layer-name">${layer.name}</span>
          <span class="layer-type">${layer.type}</span>
        </div>
      `;

      if (hasChildren && isExpanded) {
        for (const child of layer.children) {
          html += renderLayer(child, depth + 1);
        }
      }

      return html;
    }

    function renderLayers() {
      console.log("üé® Rendering layers...");
      if (!layersData || layersData.length === 0) {
        showStatus("No layers found");
        return;
      }

      let html = '';
      for (const page of layersData) {
        html += renderLayer(page);
      }

      layersPanel.innerHTML = html;
      console.log("‚úÖ Layers rendered");
    }

    function selectLayer(layer) {
      console.log("üéØ Layer selected:", layer.name);
      selectedLayer = layer;
      renderLayers();
      updateButtons();
    }

    function updateButtons() {
      const hasSelection = !!selectedLayer;
      selectBtn.disabled = !hasSelection;
      copyBtn.disabled = !hasSelection;
    }

    function requestLayers() {
      console.log("üì® Requesting layers...");
      showStatus("Loading layers...");
      parent.postMessage({
        pluginMessage: { type: 'get-layers' }
      }, '*');
    }

    // Event listeners
    layersPanel.addEventListener('click', (e) => {
      if (e.target.classList.contains('expand-btn')) {
        const layerId = e.target.dataset.toggle;
        if (layerId) {
          if (expandedItems.has(layerId)) {
            expandedItems.delete(layerId);
          } else {
            expandedItems.add(layerId);
          }
          renderLayers();
        }
        e.stopPropagation();
        return;
      }

      const layerItem = e.target.closest('.layer-item');
      if (layerItem) {
        const layerId = layerItem.dataset.layerId;
        const layer = findLayerById(layersData, layerId);
        if (layer) {
          selectLayer(layer);
        }
      }
    });

    selectBtn.addEventListener('click', () => {
      if (selectedLayer) {
        parent.postMessage({
          pluginMessage: {
            type: 'select-layer',
            layerId: selectedLayer.id
          }
        }, '*');
      }
    });

    copyBtn.addEventListener('click', () => {
      if (selectedLayer) {
        const data = JSON.stringify(selectedLayer, null, 2);
        navigator.clipboard.writeText(data).then(() => {
          copyBtn.textContent = 'Copied!';
          setTimeout(() => {
            copyBtn.textContent = 'Copy JSON';
          }, 1500);
        }).catch(() => {
          alert('Failed to copy to clipboard');
        });
      }
    });

    refreshBtn.addEventListener('click', () => {
      requestLayers();
    });

    function findLayerById(layers, id) {
      for (const layer of layers) {
        if (layer.id === id) return layer;
        if (layer.children) {
          const found = findLayerById(layer.children, id);
          if (found) return found;
        }
      }
      return null;
    }

    // Handle messages from plugin
    window.onmessage = (event) => {
      console.log("üì® Message received:", event.data);
      const { type, data, message } = event.data.pluginMessage || {};
      
      switch (type) {
        case 'layers-data':
          console.log("üìã Layers data received");
          layersData = data;
          renderLayers();
          break;
        case 'layer-selected':
          selectBtn.textContent = 'Selected!';
          setTimeout(() => {
            selectBtn.textContent = 'Select in Figma';
          }, 1500);
          break;
        case 'error':
          console.error("‚ùå Error:", message);
          showError(message);
          break;
      }
    };

    // Initialize
    console.log("üöÄ Requesting initial layers...");
    requestLayers();
    console.log("‚úÖ UI ready");
  </script>
</body>
</html>